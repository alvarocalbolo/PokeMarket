<!doctype html>
<html lang="es" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <title>PokeMarket - Inicio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- CSS global compartido -->
  <link rel="stylesheet" href="CSS/style.css">
  <script src="js/api-service.js"></script>
  <script src="js/custom_db.js"></script>
</head>

<body class="bg-pokeballs">

  <!-- NAVBAR PRINCIPAL INDEX -->
  <nav class="navbar navbar-main shadow-sm sticky-top">
    <div class="container d-flex align-items-center justify-content-between">

      <!-- Lado izquierdo: logo + nombre + bot√≥n colecci√≥n -->
      <div class="d-flex align-items-center gap-3">
        <a class="navbar-brand d-flex align-items-center gap-2 mb-0" href="index.html">
          <img src="img/Masterball.png" alt="Masterball" style="width: 40px; height: 40px;">
          <span class="brand-text">PokeMarket</span>
        </a>
        <a href="Pages/Colecci√≥n.html" class="btn btn-sm btn-outline-light d-inline-flex align-items-center gap-1">
          <i class="bi bi-collection"></i>
          <span class="d-none d-md-inline">Colecci√≥n</span>
        </a>
      </div>

      <!-- Lado derecho: cr√©ditos + perfil -->
      <div class="d-flex align-items-center gap-2 flex-nowrap">

        <!-- Cr√©ditos globales: solo icono + n√∫mero -->
        <div class="d-flex align-items-center gap-1" id="globalCredits">
          <img src="img/moneda_PokeMarket.png" class="coin-icon me-1" alt="Coins">
          <span class="fw-bold">0</span>
        </div>

        <!-- Dropdown perfil -->
        <div class="dropdown">
          <button class="btn btn-profile d-flex align-items-center" type="button" id="profileDropdown"
            data-bs-toggle="dropdown" aria-expanded="false">
            <img src="img/avatars/pokeball.png" alt="Avatar" class="avatar-navbar" id="navbarAvatar">
            <span class="d-none d-lg-inline user-name ms-2" id="navbarUserName">
              Entrenador
            </span>
            <i class="bi bi-caret-down-fill ms-1 small d-none d-lg-inline"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="profileDropdown">
            <li class="px-3 py-2">
              <div class="d-flex align-items-center">
                <img src="img/avatars/pokeball.png" alt="Avatar" class="avatar-navbar me-2" id="dropdownAvatar">
                <div class="min-w-0">
                  <div class="fw-semibold small text-truncate" id="dropdownUserName">Entrenador</div>
                  <div class="text-muted xsmall text-truncate" id="dropdownUserEmail">
                    entrenador@pokemarket.com
                  </div>
                </div>
              </div>
            </li>
            <li>
              <hr class="dropdown-divider my-1">
            </li>
            <li>
              <a class="dropdown-item small" href="Pages/Perfil.html">
                <i class="bi bi-person-badge me-2"></i>Ver perfil
              </a>
            </li>
            <li>
              <a class="dropdown-item small" href="Pages/InicioSesion.html" id="logoutLink">
                <i class="bi bi-box-arrow-right me-2"></i>Cerrar sesi√≥n
              </a>
            </li>
          </ul>
        </div>

      </div>
    </div>
  </nav>

  <main class="py-4">
    <div class="container">

      <!-- SECCI√ìN RULETA PRINCIPAL -->
      <section class="mb-4">
        <header class="text-center mb-5 roulette-header position-relative hero-enhanced">
          <div class="pegi-indicator shadow-sm" data-bs-toggle="modal" data-bs-target="#pegiModal"
            title="Informaci√≥n de clasificaci√≥n y juego responsable">
            <img src="img/pegi18.svg" alt="PEGI 18">
          </div>
          <p class="text-uppercase small text-muted mb-2 tracking-wide">Casino de cartas</p>
          <h1 class="display-4 fw-black mb-3 text-shadow-hero">Ruletas Insanas de PokeMarket</h1>
          <p class="lead text-muted mb-0">
            Gira la ruleta, sube de rareza y convierte tus
            <span class="fw-semibold text-body-emphasis"><img src="img/moneda_PokeMarket.png" class="coin-icon"
                alt="Coins"> monedas</span>
            en cartas absurdamente buenas.
          </p>
        </header>

        <!-- Botones Hero CTAs -->
        <div class="d-flex justify-content-center align-items-center gap-3 mb-5">
          <button type="button" class="btn btn-buy-credits btn-lg px-4" data-bs-toggle="modal"
            data-bs-target="#creditShopModal">
            <span class="btn-buy-credits-glow"></span>
            <i class="bi bi-plus-circle-fill me-2"></i>Comprar monedas
          </button>
          <a href="Pages/Colecci√≥n.html" class="btn btn-outline-secondary btn-lg px-4 rounded-pill">
            <i class="bi bi-collection me-2"></i>Colecci√≥n
          </a>
        </div>

        <!-- Selector de ruletas (Solo Base Set) -->
        <section class="roulette-selector mb-4">
          <div class="row justify-content-center">
            <div class="col-12 col-md-6 col-lg-5">
              <article class="roulette-choice-card active" data-wheel="common">
                <div class="roulette-choice-badge">Original 1999</div>
                <h2 class="h6 mb-1">Ruleta Base Set</h2>
                <p class="xsmall mb-2 text-muted">Contiene todas las cartas de la colecci√≥n original. ¬°Haz clic para
                  activar!</p>
                <ul class="roulette-choice-tags xsmall mb-2">
                  <li>Tipo: Colecci√≥n Principal</li>
                  <li>Coste por giro: <img src="img/moneda_PokeMarket.png" class="coin-icon" alt="Coins"> 400</li>
                </ul>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="roulette-choice-price d-flex align-items-center gap-1">
                    <img src="img/moneda_PokeMarket.png" class="coin-icon" alt="Coins">
                    <span>400</span>
                  </span>
                  <span class="badge bg-warning-subtle text-warning-emphasis xsmall">Solo Base Set</span>
                </div>
              </article>
            </div>
          </div>
        </section>


        <!-- RULETA + panel derecha -->
        <div class="row g-4 align-items-start">

          <!-- RULETA -->
          <div class="col-lg-8">
            <section class="roulette-card card border-0 shadow-lg rounded-4">
              <div class="card-header border-0 roulette-card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <span class="badge bg-danger-subtle text-danger-emphasis xsmall me-2">
                      <i class="bi bi-lightning-charge-fill me-1"></i>Ruleta activa
                    </span>
                    <span class="badge bg-warning-subtle text-warning-emphasis xsmall">
                      Solo cartas del Base Set (1999)
                    </span>
                  </div>
                  <div class="text-end">
                    <span class="xsmall text-muted d-block">Balance</span>
                    <span class="small fw-semibold text-success d-flex align-items-center justify-content-end gap-1"
                      id="balanceCredits">
                      <img src="img/moneda_PokeMarket.png" class="coin-icon" alt="Coins">
                      <span>0</span>
                    </span>
                  </div>
                </div>
              </div>
              <div class="card-body roulette-body">
                <!-- Tipo de Set -->
                <div class="roulette-rarities d-flex justify-content-center align-items-center mb-3">
                  <div class="rarity-pill rarity-1"><span class="rarity-color-dot"></span>Base Set</div>
                </div>

                <!-- Ventana ruleta -->
                <div class="roulette-window-wrapper mb-3">
                  <div class="roulette-highlight"></div>
                  <div class="roulette-window">
                    <div class="roulette-strip" id="rouletteStrip"></div>
                  </div>
                  <div class="roulette-bottom-glow"></div>
                </div>

                <!-- Resultado -->
                <div class="roulette-result text-center mb-3" id="rouletteResult">
                  <span class="small text-info">
                    <i class="bi bi-dice-5 me-1"></i>Cargando cartas TCG...
                  </span>
                </div>

                <!-- Controles -->
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <div class="d-flex align-items-center gap-1">
                      <span class="xsmall text-muted">Auto giros:</span>
                      <select class="form-select form-select-sm roulette-autospins-select" id="autoCount">
                        <option value="5">5 giros</option>
                        <option value="10" selected>10 giros</option>
                        <option value="15">15 giros</option>
                        <option value="20">20 giros</option>
                        <option value="25">25 giros</option>
                        <option value="30">30 giros (MAX)</option>
                      </select>
                    </div>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-secondary btn-sm" type="button" id="btnAuto" disabled>
                        <i class="bi bi-arrow-repeat me-1"></i>Auto giros
                      </button>
                      <button class="btn btn-outline-danger btn-sm d-none" type="button" id="btnStopAuto">
                        <i class="bi bi-stop-circle me-1"></i>Parar
                      </button>
                    </div>
                  </div>
                  <div class="text-end">
                    <div class="xsmall text-muted mb-1 d-flex align-items-center justify-content-end gap-1">
                      <span>Coste por giro:</span>
                      <span class="text-warning fw-semibold d-flex align-items-center gap-1" id="spinCost">
                        <img src="img/moneda_PokeMarket.png" class="coin-icon" alt="Coins">
                        <span>20</span>
                      </span>
                    </div>
                    <button class="btn btn-poke btn-lg fw-semibold" id="btnSpin" disabled>
                      <i class="bi bi-dice-5 me-1"></i>Girar 1 vez
                    </button>
                  </div>
                </div>
              </div>

              <div class="card-footer border-0 roulette-footer xsmall text-muted">
                Los objetos ganados se a√±aden autom√°ticamente a tu colecci√≥n. Puedes gestionarlos desde la p√°gina de
                <a href="Pages/Colecci√≥n.html" class="text-warning text-decoration-none fw-semibold">Colecci√≥n</a>.
              </div>
            </section>
          </div>

          <!-- PANEL DERECHA -->
          <div class="col-lg-4">
            <section class="card border-0 shadow-sm rounded-4 mb-3">
              <div class="card-body">
                <h2 class="h6 fw-semibold mb-2"><i class="bi bi-graph-up-arrow me-1"></i>Probabilidades base</h2>
                <ul class="list-unstyled mb-0 xsmall" id="baseProbList"></ul>
              </div>
            </section>

            <section class="card border-0 shadow-sm rounded-4 mb-3">
              <div class="card-body">
                <h2 class="h6 fw-semibold mb-2"><i class="bi bi-activity me-1"></i>Tendencia de tus giros</h2>
                <p class="xsmall text-muted">Basado en las √∫ltimas sesiones de ruleta.</p>
                <ul class="list-unstyled mb-0 xsmall" id="currentProbList"></ul>
              </div>
            </section>

            <section class="card border-0 shadow-sm rounded-4">
              <div class="card-body">
                <h2 class="h6 fw-semibold mb-2"><i class="bi bi-trophy-fill text-warning me-1"></i>√öltimos drops √©picos
                </h2>
                <ul class="list-unstyled mb-0 xsmall" id="lastDrops"></ul>
              </div>
            </section>
          </div>
        </div>
      </section>

      <!-- SECCI√ìN TIENDA R√ÅPIDA -->
      <hr class="my-5">

      <!-- Tienda Header Redesign -->
      <div class="shop-header-container mb-4 p-4 rounded-4 shadow-lg position-relative overflow-hidden">
        <div class="shop-header-bg"></div>
        <div class="d-flex flex-wrap justify-content-between align-items-center position-relative z-1 gap-3">

          <!-- Title Area -->
          <div class="shop-title-area">
            <div class="d-flex align-items-center gap-2 mb-1">
              <span class="badge bg-warning text-dark fw-bold px-2 py-1"
                style="font-size: 0.7rem; letter-spacing: 1px;">MERCADO</span>
              <span class="xsmall text-info text-uppercase" style="letter-spacing: 2px;">‚Ä¢ INSTANT√ÅNEO</span>
            </div>
            <h2 class="display-6 fw-bold text-white mb-0" style="text-shadow: 0 2px 10px rgba(0,0,0,0.5);">
              Tienda Diaria
            </h2>
            <p class="text-light opacity-75 mb-0 xsmall" style="max-width: 400px;">
              Selecci√≥n rotativa de cartas. Adquiere piezas √∫nicas directamente con tu saldo.
              Stock limitado a tu velocidad de clic.
            </p>
          </div>

          <!-- Action Area -->
          <div class="d-flex flex-column align-items-end gap-3">

            <!-- Balance Wallet -->
            <div
              class="shop-balance-pill d-flex align-items-center gap-3 px-3 py-2 rounded-pill bg-dark border border-secondary shadow-sm">
              <span class="xsmall text-muted text-uppercase fw-bold" style="letter-spacing: 1px;">Tu Saldo</span>
              <span class="shop-balance-amount text-warning fw-bold fs-5 d-flex align-items-center gap-2"
                id="shopCredits">
                <img src="img/moneda_PokeMarket.png" class="coin-icon" alt="Coins">
                <span>0</span>
              </span>
            </div>

            <!-- Reload Control -->
            <div class="d-flex align-items-center gap-3">
              <span class="xsmall text-muted fst-italic text-end d-none d-md-block" id="dailyResetLabel">
                <i class="bi bi-clock me-1"></i>Reset: 00:00
              </span>

              <button class="btn btn-recargar-tienda-premium position-relative overflow-hidden" id="btnRefreshDaily">
                <div class="d-flex align-items-center gap-2 px-3 py-2">
                  <i class="bi bi-arrow-repeat fs-5"></i>
                  <div class="d-flex flex-column align-items-start lh-1">
                    <span class="fw-bold xsmall text-uppercase">Recargar</span>
                    <span class="text-warning xsmall fw-bold d-flex align-items-center gap-1">
                      <img src="img/moneda_PokeMarket.png" class="coin-icon" alt="Coins">
                      <span id="refreshCostLabel">1000</span>
                    </span>
                  </div>
                </div>
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Cartas diarias Grid -->
      <section class="mb-5 tienda-section-grid">
        <!-- (Header removed from here, moved up) -->

        <div class="card-body">
          <div class="row g-3" id="dailyCardsGrid">
            <!-- Plantilla -->
            <!-- Plantilla -->
            <div class="col-12 col-md-6 col-lg-4 d-none" id="dailyCardTemplate">
              <article class="card card-carta h-100 tienda-card-dia">
                <div class="daily-sold-overlap d-none">
                  <span>SOLD</span>
                </div>

                <div class="card-carta-frame">
                  <div class="carta-img-placeholder d-flex align-items-center justify-content-center">
                    <span class="xsmall text-muted">Imagen</span>
                  </div>
                </div>

                <div class="card-body daily-card-body p-0">
                  <!-- Separator -->
                  <div class="daily-separator">
                    <span class="separator-line"></span>
                    <span class="separator-diamond">‚ùñ</span>
                    <span class="separator-line"></span>
                  </div>

                  <!-- Name info -->
                  <div class="daily-info-container">
                    <h5 class="daily-name text-truncate">Nombre</h5>
                    <span class="badge xsmall daily-rarity">Rara</span>
                  </div>

                  <!-- Price Button -->
                  <div class="daily-action-container">
                    <button class="btn daily-buy-btn tienda-dia-btn-comprar">
                      <div class="d-flex align-items-center justify-content-center gap-1">
                        <img src="img/moneda_PokeMarket.png" class="coin-icon" alt="Coins">
                        <span class="daily-price">0</span>
                      </div>
                    </button>
                  </div>

                  <p class="xsmall text-muted mb-0 daily-stock d-none">Stock: 1</p>
                  <p class="daily-set d-none"></p>
                </div>
              </article>
            </div>
            <!-- /plantilla -->
            <p class="text-muted small mb-0" id="dailyEmptyText">Cargando selecci√≥n diaria...</p>
          </div>
        </div>
      </section>

      <!-- SECCI√ìN SOBRES -->
      <!-- SECCI√ìN SOBRES (Hearthstone Style) -->
      <section class="mb-5">
        <header class="mb-3">
          <p class="text-uppercase xsmall text-muted mb-1">F√°brica de dopamina</p>
          <h3 class="h5 fw-semibold">Sobres PokeMarket ‚Äì Abre y reza</h3>
        </header>

        <div class="shop-packs-container">

          <!-- LEFT PANEL: FEATURED SET -->
          <div class="pack-feature-panel">
            <div class="pack-feature-ribbon">Latest Expansion</div>

            <!-- 3D CSS BOX Placeholder (Fallback until PNG is added) -->
            <!-- 3D CSS BOX Placeholder (Fallback until PNG is added) -->
            <img src="img/caja199.png" class="booster-box-display" alt="Base Set 1999 Booster Box">

            <h2 class="pack-feature-title">BASE SET</h2>
            <div class="pack-feature-subtitle">1st Edition ‚Ä¢ 1999</div>
          </div>

          <!-- RIGHT PANEL: PACK GRID -->
          <div class="pack-grid-panel">
            <div class="pack-grid-inner" id="packsGrid">

              <!-- Item 1: Venusaur -->
              <div class="hearth-pack-item" onclick="openPack('base1_venusaur')">
                <!-- JS handler manual fallback or let existing script attach -->
                <div class="hearth-pack-frame">
                  <img src="img/pack-venusaur.png" class="hearth-pack-image" alt="Venusaur Pack">
                </div>
                <div class="hearth-pack-label">Venusaur</div>
                <div class="hearth-pack-price">
                  <img src="img/moneda_PokeMarket.png" class="coin-icon" alt="Coins"> 1500
                </div>
                <button class="hearth-pack-btn pack-open-btn" data-pack-id="base1_venusaur">ABRIR</button>
              </div>

              <!-- Item 2: Charizard -->
              <div class="hearth-pack-item" onclick="openPack('base1_charizard')">
                <div class="hearth-pack-frame">
                  <img src="img/pack-charizard.png" class="hearth-pack-image" alt="Charizard Pack">
                </div>
                <div class="hearth-pack-label">Charizard</div>
                <div class="hearth-pack-price">
                  <img src="img/moneda_PokeMarket.png" class="coin-icon" alt="Coins"> 1500
                </div>
                <button class="hearth-pack-btn pack-open-btn" data-pack-id="base1_charizard">ABRIR</button>
              </div>

              <!-- Item 3: Blastoise -->
              <div class="hearth-pack-item" onclick="openPack('base1_blastoise')">
                <div class="hearth-pack-frame">
                  <img src="img/pack-blastoise.png" class="hearth-pack-image" alt="Blastoise Pack">
                </div>
                <div class="hearth-pack-label">Blastoise</div>
                <div class="hearth-pack-price">
                  <img src="img/moneda_PokeMarket.png" class="coin-icon" alt="Coins"> 1500
                </div>
                <button class="hearth-pack-btn pack-open-btn" data-pack-id="base1_blastoise">ABRIR</button>
              </div>

            </div>
          </div>

        </div>
      </section>
      <p class="roulette-disclaimer text-center mt-4">
        Probabilidades fijas por rareza, ruleta y tipo de sobre. Juega con cabeza y disfruta del vicio controlado.
      </p>

    </div>
  </main>

  <!-- Toast notificaciones -->
  <div class="roulette-toast-container" id="toastContainer"></div>

  <!-- Modal recompensa carta (ruleta) -->
  <div class="modal fade reward-modal" id="rewardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content reward-modal-content">
        <div class="reward-glow"></div>
        <div class="reward-rays"></div>
        <div class="modal-body text-center">
          <p class="xsmall text-muted mb-1">¬°Nueva recompensa!</p>
          <h2 class="h5 fw-bold mb-2" id="rewardTitle">Has conseguido una carta</h2>

          <div class="reward-card-wrapper">
            <div class="reward-card-inner">
              <img id="rewardImage" src="" alt="Carta obtenida">
            </div>
          </div>

          <p class="mt-2 mb-1">
            <span class="badge" id="rewardRarityBadge">Base Set</span>
          </p>
          <p class="small text-muted mb-0" id="rewardSetName"></p>

          <div class="mt-3 d-flex justify-content-center gap-2">
            <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal" id="rewardContinueBtn">
              Seguir girando
            </button>
            <a href="Pages/Colecci√≥n.html" class="btn btn-warning btn-sm" id="btnGoCollection">
              Ir a colecci√≥n
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal compra cr√©ditos -->
  <div class="modal fade modal-coin-shop" id="creditShopModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header border-0">
          <div>
            <h5 class="modal-title fw-bold">Tienda de Monedas</h5>
            <p class="xsmall text-muted mb-0">Compra monedas para seguir girando</p>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body p-4">
          <div class="row g-4 mb-4">
            <!-- Pack 1 -->
            <div class="col-12 col-md-4">
              <div class="coin-pack-card tier-1" data-amount="2500" data-cost="2.99">
                <div class="coin-pack-icon"><img src="img/moneda_PokeMarket.png" class="coin-icon" alt="Coins"></div>
                <div class="coin-pack-amount">2,500</div>
                <div class="coin-pack-bonus"><span
                    class="badge bg-secondary-subtle text-secondary-emphasis xsmall">B√°sico</span></div>
                <div class="coin-pack-price">2,99 ‚Ç¨</div>
              </div>
            </div>
            <!-- Pack 2 -->
            <div class="col-12 col-md-4">
              <div class="coin-pack-card tier-2" data-amount="12000" data-cost="9.99">
                <div class="pack-badge">POPULAR</div>
                <div class="coin-pack-icon"><i class="bi bi-layers-fill"></i></div>
                <div class="coin-pack-amount">12,000</div>
                <div class="coin-pack-bonus">+ 20% Extra</div>
                <div class="coin-pack-price">9,99 ‚Ç¨</div>
              </div>
            </div>
            <!-- Pack 3 -->
            <div class="col-12 col-md-4">
              <div class="coin-pack-card tier-3" data-amount="75000" data-cost="49.99">
                <div class="pack-badge">MEJOR VALOR</div>
                <div class="coin-pack-icon"><i class="bi bi-trophy-fill"></i></div>
                <div class="coin-pack-amount">75,000</div>
                <div class="coin-pack-bonus">¬°+ 50% GRATIS!</div>
                <div class="coin-pack-price">49,99 ‚Ç¨</div>
              </div>
            </div>
          </div>

          <!-- Admin Section -->
          <div class="admin-code-section">
            <div class="d-flex flex-column flex-sm-row align-items-center gap-2 justify-content-center">
              <label for="adminCodeInput" class="small text-muted mb-0">C√≥digo Promocional:</label>
              <div class="input-group input-group-sm" style="max-width: 300px;">
                <span class="input-group-text"><i class="bi bi-ticket-perforated"></i></span>
                <input type="text" class="form-control admin-code-input" id="adminCodeInput"
                  placeholder="A√ëADIR C√ìDIGO">
                <button class="btn btn-poke fw-bold" type="button" id="btnRedeemCode">Canjear</button>
              </div>
            </div>
            <p class="xsmall text-center text-muted mt-2 mb-0 opacity-50">Solo para administradores</p>
          </div>
        </div>

      </div>
    </div>
  </div>
  </div>

  <!-- Modal info probabilidades sobre -->
  <div class="modal fade" id="packInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title xsmall" id="packInfoTitle">Probabilidades sobre</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="list-unstyled xsmall mb-0" id="packInfoList"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal apertura sobre (animaci√≥n dopamina) -->
  <div class="modal fade" id="openPackModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="openPackTitle">Sobre abierto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">

          <!-- Etapa reveal carta a carta -->
          <div id="packRevealStage">
            <div class="pack-reveal-backdrop">
              <div class="pack-reveal-card-slot">
                <!-- carta activa se pinta por JS -->
              </div>
            </div>
            <div class="text-center mt-2">
              <p class="xsmall text-muted mb-1" id="packRevealCounter">
                Carta 1 de 6
              </p>
              <button class="btn btn-poke btn-sm" id="btnNextReveal">
                Ver siguiente carta
              </button>
            </div>
          </div>

          <!-- Resumen final -->
          <div id="packSummaryStage" class="d-none mt-3">
            <h6 class="small fw-semibold mb-2">
              <i class="bi bi-collection me-1"></i>
              Resumen del sobre
            </h6>
            <div class="row g-2" id="packCardsGrid"></div>
          </div>

          <p class="xsmall text-muted mb-0 mt-2">
            Las cartas se han a√±adido a tu colecci√≥n.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
            Cerrar
          </button>
          <a href="Pages/Colecci√≥n.html" class="btn btn-poke btn-sm">
            Ver colecci√≥n
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- JS Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script principal: tema, usuario, ruleta, tienda, sobres -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Force Dark Mode
      document.documentElement.setAttribute('data-bs-theme', 'dark');
      localStorage.setItem('bsTheme', 'dark');

      const defaultName = 'Entrenador';
      const defaultEmail = 'entrenador@pokemarket.com';
      const defaultAvatar = 'img/avatars/pokeball.png';

      const name = localStorage.getItem('pm_user_name') || defaultName;
      const email = localStorage.getItem('pm_user_email') || defaultEmail;
      const avatar = localStorage.getItem('pm_user_avatar') || defaultAvatar;

      const navbarUserName = document.getElementById('navbarUserName');
      const dropdownUserName = document.getElementById('dropdownUserName');
      const dropdownUserEmail = document.getElementById('dropdownUserEmail');
      const navbarAvatar = document.getElementById('navbarAvatar');
      const dropdownAvatar = document.getElementById('dropdownAvatar');

      if (navbarUserName) navbarUserName.textContent = name;
      if (dropdownUserName) dropdownUserName.textContent = name;
      if (dropdownUserEmail) dropdownUserEmail.textContent = email;
      if (navbarAvatar) navbarAvatar.src = avatar;
      if (dropdownAvatar) dropdownAvatar.src = avatar;

      const logoutLink = document.getElementById('logoutLink');
      if (logoutLink) {
        logoutLink.addEventListener('click', () => {
          localStorage.removeItem('pm_user_name');
          localStorage.removeItem('pm_user_email');
          localStorage.removeItem('pm_user_avatar');
          localStorage.removeItem('pm_user_bio');
          localStorage.removeItem('pm_cards_sale');
          localStorage.removeItem('pm_collection');
          localStorage.removeItem('pm_credits');
        });
      }

      // Sistema de Notificaciones (Toasts)
      window.showToast = function (data) {
        const container = document.getElementById('toastContainer');
        if (!container) return;

        const rarityClass = data.rarityInternal ? `rarity-${data.rarityInternal}` : 'rarity-common';
        // Icono seg√∫n rareza o tipo
        let iconHtml = '<i class="bi bi-info-lg"></i>';
        if (data.rarityInternal === 'mythic' || data.rarityInternal === 'legendary') {
          iconHtml = '<i class="bi bi-star-fill text-warning"></i>';
        } else if (data.rarityInternal === 'epic') {
          iconHtml = '<i class="bi bi-lightning-fill text-warning"></i>';
        } else if (data.name && data.name.includes('Error')) {
          iconHtml = '<i class="bi bi-x-lg"></i>';
        } else if (data.name && data.name.includes('Comprada')) {
          iconHtml = '<i class="bi bi-bag-check-fill"></i>';
        }

        const toast = document.createElement('div');
        toast.className = `toast-notification ${rarityClass}`;
        toast.innerHTML = `
          <div class="toast-icon">${iconHtml}</div>
          <div class="toast-body">
            <div class="toast-title">${data.name || 'Notificaci√≥n'}</div>
            ${data.rarity ? `<div class="toast-desc">${data.rarity.label}</div>` : ''}
          </div>
        `;

        container.appendChild(toast);

        // Auto remove
        setTimeout(() => {
          toast.style.animation = 'toast-out 0.4s forwards';
          toast.addEventListener('animationend', () => {
            toast.remove();
          });
        }, 3500);
      };

      const rarityDefs = [
        { id: 1, key: 'basic', label: 'B√°sico' },
        { id: 2, key: 'common', label: 'Com√∫n' },
        { id: 3, key: 'uncommon', label: 'Poco Com√∫n' },
        { id: 4, key: 'rare', label: 'Raro' },
        { id: 5, key: 'epic', label: '√âpico' },
        { id: 6, key: 'legendary', label: 'Legendario' }
      ];

      const wheelsConfig = {
        common: {
          name: 'Ruleta Base Set',
          cost: 400,
          probs: {
            basic: 0.55,
            common: 0.28,
            uncommon: 0.12,
            rare: 0.04,
            epic: 0.009,
            legendary: 0.001
          }
        }
      };

      const packRarityProbs = {
        base1_venusaur: {
          name: 'Sobre Venusaur',
          price: 1500,
          cardCount: 3,
          artClass: 'pack-art-venusaur',
          probs: { basic: 0.55, common: 0.28, uncommon: 0.12, rare: 0.04, epic: 0.009, legendary: 0.001 }
        },
        base1_charizard: {
          name: 'Sobre Charizard',
          price: 1500,
          cardCount: 3,
          artClass: 'pack-art-charizard',
          probs: { basic: 0.55, common: 0.28, uncommon: 0.12, rare: 0.04, epic: 0.009, legendary: 0.001 }
        },
        base1_blastoise: {
          name: 'Sobre Blastoise',
          price: 1500,
          cardCount: 3,
          artClass: 'pack-art-blastoise',
          probs: { basic: 0.55, common: 0.28, uncommon: 0.12, rare: 0.04, epic: 0.009, legendary: 0.001 }
        }
      };

      const rarityPriceMap = {
        basic: 1,
        common: 5,
        uncommon: 15,
        rare: 40,
        epic: 90,
        legendary: 280
      };

      const TCG_API_BASE = 'https://api.tcgdex.net/v2/en/cards';

      function fnv1aHash(str) {
        let hash = 2166136261 >>> 0;
        for (let i = 0; i < str.length; i++) {
          hash ^= str.charCodeAt(i);
          hash = Math.imul(hash, 16777619) >>> 0;
        }
        return hash >>> 0;
      }

      function mapApiRarityToInternal(price) {
        return ApiService.calculateRarityByPrice(price);
      }

      const cardsByRarity = {
        basic: [], common: [], uncommon: [], rare: [], epic: [], legendary: []
      };
      window.cardsByRarity = cardsByRarity;

      async function loadAllCardsFromApi() {
        if (resultBox) {
          resultBox.innerHTML = '<span class="xsmall text-muted"><i class="bi bi-sync-alt me-1"></i>Sincronizando mercado de cartas (TCGdex)...</span>';
        }

        try {
          const sets = await ApiService.fetchSets();
          // Filter to ONLY use Base Set 1
          const baseSet = sets.find(s => s.id === 'base1');

          if (!baseSet) {
            console.warn("Base Set 1 not found in sets list.");
          }

          // Use our custom DB for card data, but API for images/ids
          const targetSets = baseSet ? [baseSet] : [];

          for (const set of targetSets) {
            const cards = await ApiService.fetchCardsBySet(set.id);
            cards.forEach(card => {
              // Use localId as key string "1", "2"
              const localIdStr = String(parseInt(card.localId || '0'));
              const customData = window.BASE_SET_DB ? window.BASE_SET_DB[localIdStr] : null;

              if (customData) {
                const rarityKey = customData.r; // basic, common, uncommon...
                const cardObj = {
                  id: card.id,
                  localId: card.localId,
                  setId: set.id,
                  name: customData.n,
                  image: card.image ? `${card.image}/high.png` : 'img/avatars/pokeball.png',
                  rarityInternal: rarityKey,
                  apiRarity: card.rarity || '',
                  rarityLabel: rarityDefs.find(r => r.key === rarityKey)?.label || 'B√°sico',
                  setName: 'Base Set',
                  types: card.types || [],
                  holographic: rarityKey === 'epic' || rarityKey === 'legendary' || rarityKey === 'rare',
                  priceEur: customData.p,
                  priceUsd: Number((customData.p * 1.1).toFixed(2))
                };

                if (cardsByRarity[rarityKey]) {
                  cardsByRarity[rarityKey].push(cardObj);
                }
              }
            });
          }

          if (resultBox) {
            resultBox.innerHTML = '<span class="xsmall text-success"><i class="bi bi-check-circle me-1"></i>Mercado listo.</span>';
          }
          enableSpinButtons();
          generateDailyCards(); // Trigger store generation once cards are ready
        } catch (err) {
          console.error('Error loading cards:', err);
          if (resultBox) {
            resultBox.innerHTML = '<span class="xsmall text-danger">Error al cargar cartas de la API.</span>';
          }
        }
      }

      function enableSpinButtons() {
        if (btnSpin) btnSpin.disabled = balance < spinCost;
        if (btnAuto) btnAuto.disabled = balance < spinCost;
      }

      function getRandomCardFromRarity(rarityKey) {
        const pool = cardsByRarity[rarityKey] || [];
        if (!pool.length) return null;
        const base = pool[Math.floor(Math.random() * pool.length)];
        return {
          ...base,
          rarityInternal: rarityKey,
          rarity: rarityDefs.find(r => r.key === rarityKey) || rarityDefs[0]
        };
      }

      function getDailySeed() {
        const now = new Date();
        const y = now.getUTCFullYear();
        const m = now.getUTCMonth() + 1;
        const d = now.getUTCDate();
        return `${y}-${m}-${d}`;
      }

      function seededRandom(seed, max) {
        const hash = fnv1aHash(seed);
        return hash % max;
      }

      function pickPackRarity(packId) {
        const cfg = packRarityProbs[packId];
        if (!cfg) return rarityDefs[0];
        const entries = Object.entries(cfg.probs);
        const total = entries.reduce((sum, [, p]) => sum + p, 0);
        const r = Math.random() * total;
        let acc = 0;
        for (const [key, p] of entries) {
          acc += p;
          if (r <= acc) {
            return rarityDefs.find(rd => rd.key === key);
          }
        }
        const fallbackKey = entries[0][0];
        return rarityDefs.find(rd => rd.key === fallbackKey);
      }

      function getRandomCardFromPack(packId) {
        const rarity = pickPackRarity(packId);
        const pool = cardsByRarity[rarity.key] || [];
        if (!pool.length) {
          return {
            id: null,
            name: 'Carta desconocida',
            image: '',
            rarityInternal: rarity.key,
            rarity,
            apiRarity: '',
            setName: '',
            types: [],
            holographic: false,
            priceEur: null,
            priceUsd: null
          };
        }
        const base = pool[Math.floor(Math.random() * pool.length)];
        return {
          ...base,
          rarity,
          rarityInternal: rarity.key
        };
      }

      const rouletteStrip = document.getElementById('rouletteStrip');
      const btnSpin = document.getElementById('btnSpin');
      const btnAuto = document.getElementById('btnAuto');
      const btnStopAuto = document.getElementById('btnStopAuto');
      const autoCountSelect = document.getElementById('autoCount');
      const resultBox = document.getElementById('rouletteResult');
      const lastDropsList = document.getElementById('lastDrops');
      const currentProbList = document.getElementById('currentProbList');
      const baseProbList = document.getElementById('baseProbList');
      const balanceBox = document.getElementById('balanceCredits');
      const spinCostEl = document.getElementById('spinCost');
      const toastContainer = document.getElementById('toastContainer');
      const wheelCards = document.querySelectorAll('.roulette-choice-card');
      const btnGoCollection = document.getElementById('btnGoCollection');
      const globalCreditsEl = document.getElementById('globalCredits');
      const shopCreditsEl = document.getElementById('shopCredits');
      const packsGrid = document.getElementById('packsGrid');
      const openPackModalEl = document.getElementById('openPackModal');
      const packInfoModalEl = document.getElementById('packInfoModal');
      const packInfoTitleEl = document.getElementById('packInfoTitle');
      const packInfoListEl = document.getElementById('packInfoList');
      const packRevealStage = document.getElementById('packRevealStage');
      const packSummaryStage = document.getElementById('packSummaryStage');
      const packRevealSlot = packRevealStage ? packRevealStage.querySelector('.pack-reveal-card-slot') : null;
      const packRevealCounter = document.getElementById('packRevealCounter');
      const btnNextReveal = document.getElementById('btnNextReveal');
      const dailyCardsGrid = document.getElementById('dailyCardsGrid');
      const dailyCardTemplate = document.getElementById('dailyCardTemplate');
      const dailyEmptyText = document.getElementById('dailyEmptyText');
      const btnRefreshDaily = document.getElementById('btnRefreshDaily');
      const refreshCostLabel = document.getElementById('refreshCostLabel');
      const rewardModalEl = document.getElementById('rewardModal');
      const rewardContinueBtn = document.getElementById('rewardContinueBtn');

      let openPackModal = openPackModalEl ? new bootstrap.Modal(openPackModalEl) : null;
      let packInfoModal = packInfoModalEl ? new bootstrap.Modal(packInfoModalEl) : null;

      let balance = 0;
      let currentWheelKey = 'common';
      let spinCost = wheelsConfig[currentWheelKey].cost;
      let isSpinning = false;
      let autoSpinsRemaining = 0;
      let autoSpinTimer = null;
      let lastDrops = [];
      let statsCounts = {
        basic: 0,
        common: 0,
        uncommon: 0,
        rare: 0,
        epic: 0,
        legendary: 0
      };
      let refreshDailyCost = 1000;
      let autoSpinQueueActive = false; // controla si estamos en modo autogiros
      let rewardModalInstance = rewardModalEl ? new bootstrap.Modal(rewardModalEl) : null;

      function updateRefreshCostUI() {
        if (refreshCostLabel) refreshCostLabel.textContent = refreshDailyCost.toString();
      }

      function syncCreditsUI() {
        if (balanceBox) {
          const span = balanceBox.querySelector('span:last-child');
          if (span) span.textContent = balance;
        }
        if (globalCreditsEl) {
          globalCreditsEl.innerHTML = `
        <i class="bi bi-coin text-warning"></i>
        <span class="fw-bold">${balance}</span>
      `;
        }
        if (shopCreditsEl) {
          shopCreditsEl.innerHTML = `
        <i class="bi bi-coin text-warning small"></i>
        <span>${balance}</span>
      `;
        }
      }

      function updateSpinCostUI() {
        spinCost = wheelsConfig[currentWheelKey].cost;
        if (spinCostEl) {
          spinCostEl.innerHTML = `
        <i class="bi bi-coin text-warning small"></i>
        <span>${spinCost}</span>
      `;
        }
      }

      function isNewToCollection(cardId) {
        try {
          const raw = localStorage.getItem('pm_collection');
          if (!raw) return true;
          const current = JSON.parse(raw);
          return !current.some(c => c.id === cardId);
        } catch (e) { return true; }
      }

      function addCardToCollection(card) {
        try {
          const key = 'pm_collection';
          const raw = localStorage.getItem(key);
          const current = raw ? JSON.parse(raw) : [];
          current.push({
            id: card.id,
            localId: card.localId || (card.id ? card.id.split('-')[1] : '1'),
            setId: card.setId || (card.id ? card.id.split('-')[0] : 'base1'),
            name: card.name || 'Carta desconocida',
            rarityInternal: card.rarityInternal || 'common',
            rarityLabel: card.rarityLabel || (card.rarity ? card.rarity.label : 'Base Set'),
            apiRarity: card.apiRarity || '',
            image: card.image || '',
            setName: card.setName || 'Base Set',
            types: card.types || [],
            holographic: !!card.holographic,
            priceEur: card.priceEur ?? null,
            priceUsd: card.priceUsd ?? null,
            obtainedAt: new Date().toISOString()
          });
          localStorage.setItem(key, JSON.stringify(current));
        } catch (e) {
          console.error('Error guardando colecci√≥n:', e);
        }
      }

      function showToast(card) {
        if (!toastContainer) return;
        const rarityKey = card.rarityInternal || 'common';
        const rarityDef = card.rarity || rarityDefs.find(r => r.key === rarityKey) || rarityDefs[0];

        const toast = document.createElement('div');
        toast.className = 'roulette-toast';

        toast.innerHTML = `
      <div class="roulette-toast-inner rarity-${rarityKey}">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="roulette-toast-title">
            ${isNewToCollection(card.id) ? '<span class="badge bg-danger me-1">¬°NUEVA!</span>' : ''}
            Drop ${rarityDef.label}
          </span>
          <span class="xsmall">${new Date().toLocaleTimeString()}</span>
        </div>
        <div class="roulette-toast-body">
          ${card.name || 'Carta obtenida'}
        </div>
      </div>
    `;

        toastContainer.appendChild(toast);

        requestAnimationFrame(() => {
          toast.classList.add('show');
        });

        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 250);
        }, 2500);
      }

      function raritySymbol(key) {
        return 'üî¥'; // Una simple Pok√©ball para todo el Base Set
      }

      function updateBaseProbabilitiesUI() {
        if (!baseProbList) return;
        const cfg = wheelsConfig[currentWheelKey];
        baseProbList.innerHTML = '';
        const entries = Object.entries(cfg.probs);

        entries.forEach(([key, p]) => {
          const rd = rarityDefs.find(r => r.key === key);
          if (!rd) return;
          const pct = (p * 100).toFixed(1);
          const li = document.createElement('li');
          li.className = 'stats-bar-row mb-1';
          li.innerHTML = `
        <span class="stats-bar-label">${rd.label}</span>
        <div class="stats-bar-track">
          <div class="stats-bar-fill rarity-${rd.key}" style="width:${pct}%"></div>
        </div>
        <span class="stats-bar-value">${pct}%</span>
      `;
          baseProbList.appendChild(li);
        });
      }

      function updateCurrentProbabilities() {
        if (!currentProbList) return;
        const total = Object.values(statsCounts).reduce((a, b) => a + b, 0);
        currentProbList.innerHTML = '';

        rarityDefs.forEach(rd => {
          const count = statsCounts[rd.key] || 0;
          const pct = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
          const li = document.createElement('li');
          li.className = 'stats-bar-row mb-1';
          li.innerHTML = `
        <span class="stats-bar-label">${rd.label}</span>
        <div class="stats-bar-track">
          <div class="stats-bar-fill rarity-${rd.key}" style="width:${pct}%"></div>
        </div>
        <span class="stats-bar-value">${pct}%</span>
      `;
          currentProbList.appendChild(li);
        });
      }

      function fillStrip() {
        if (!rouletteStrip) return;
        rouletteStrip.innerHTML = '';
        const cfg = wheelsConfig[currentWheelKey];
        if (!cfg) return;

        const items = [];
        const rarityEntries = Object.entries(cfg.probs);
        for (let i = 0; i < 50; i++) {
          let r = Math.random();
          let acc = 0;
          let chosenKey = 'common';
          for (const [key, prob] of rarityEntries) {
            acc += prob;
            if (r <= acc) {
              chosenKey = key;
              break;
            }
          }
          const card = getRandomCardFromRarity(chosenKey);
          if (!card) continue;
          items.push(card);
        }

        items.forEach(card => {
          const rd = rarityDefs.find(r => r.key === card.rarityInternal) || rarityDefs[0];
          const div = document.createElement('div');
          div.className = `roulette-item rarity-${card.rarityInternal}`;
          div.setAttribute('data-card-id', card.id || '');
          div.setAttribute('data-set-id', card.setId || '');
          div.setAttribute('data-local-id', card.localId || '');
          div.setAttribute('data-set-name', card.setName || '');
          div.innerHTML = `
        <div class="roulette-item-inner">
          <div class="d-flex justify-content-between align-items-center">
            <span class="roulette-item-rarity">${rd.label}</span>
            <img src="${card.image || 'img/avatars/pokeball.png'}"
                 alt="${card.name}"
                 class="roulette-item-image">
          </div>
          <div class="roulette-item-name text-truncate">${card.name}</div>
        </div>
      `;
          rouletteStrip.appendChild(div);
        });
      }

      function pickResultFromStrip() {
        const items = rouletteStrip ? rouletteStrip.querySelectorAll('.roulette-item') : [];
        if (!items.length) return null;

        const centerIndex = Math.floor(items.length / 2);
        const chosen = items[centerIndex];
        if (!chosen) return null;

        const img = chosen.querySelector('img');
        const nameEl = chosen.querySelector('.roulette-item-name');
        const rarityClass = Array.from(chosen.classList).find(c => c.startsWith('rarity-')) || 'rarity-common';
        const rarityKey = rarityClass.replace('rarity-', '');
        const rd = rarityDefs.find(r => r.key === rarityKey) || rarityDefs[0];

        const card = {
          id: chosen.getAttribute('data-card-id'),
          setId: chosen.getAttribute('data-set-id'),
          localId: chosen.getAttribute('data-local-id'),
          setName: chosen.getAttribute('data-set-name') || 'Base Set',
          name: nameEl ? nameEl.textContent : 'Carta',
          image: img ? img.src : 'img/avatars/pokeball.png',
          rarityInternal: rarityKey,
          rarity: rd,
          apiRarity: '',
        };

        return { card, elementIndex: centerIndex, itemWidth: chosen.offsetWidth };
      }

      function animateSpin() {
        if (!rouletteStrip) return;
        isSpinning = true;
        btnSpin.disabled = true;
        btnAuto.disabled = true;

        const totalItems = rouletteStrip.children.length;
        if (!totalItems) {
          isSpinning = false;
          btnSpin.disabled = false;
          btnAuto.disabled = false;
          return;
        }

        const itemWidth = rouletteStrip.children[0].offsetWidth + 4;
        const totalWidth = totalItems * itemWidth;

        const visibleWidth = rouletteStrip.parentElement.offsetWidth;
        const centerOffset = (visibleWidth / 2) - (itemWidth / 2);

        const targetIndex = Math.floor(totalItems / 2);
        const targetX = - (targetIndex * itemWidth) + centerOffset;

        const startX = targetX + totalWidth * 1.5;

        let start = null;
        const duration = 2600;

        function step(timestamp) {
          if (!start) start = timestamp;
          const elapsed = timestamp - start;
          const progress = Math.min(elapsed / duration, 1);
          const eased = 1 - Math.pow(1 - progress, 5); // Quintic ease-out m√°s fluido
          const current = startX + (targetX - startX) * eased;
          rouletteStrip.style.transform = `translateX(${current}px)`;

          if (progress < 1) {
            window.requestAnimationFrame(step);
          } else {
            rouletteStrip.style.setProperty('--roulette-offset', `${current}px`);
            rouletteStrip.classList.add('roulette-strip-bounce');
            setTimeout(() => {
              rouletteStrip.classList.remove('roulette-strip-bounce');
              onSpinEnd();
            }, 220);
          }
        }

        window.requestAnimationFrame(step);
      }

      function onSpinEnd() {
        isSpinning = false;
        const result = pickResultFromStrip();
        if (!result) {
          if (resultBox) {
            resultBox.innerHTML = `
          <span class="small text-danger">
            <i class="bi bi-exclamation-triangle me-1"></i>No se pudo determinar la carta.
          </span>
        `;
          }
        } else {
          const card = result.card;
          const rd = card.rarity;

          statsCounts[card.rarityInternal] = (statsCounts[card.rarityInternal] || 0) + 1;
          updateCurrentProbabilities();

          lastDrops.unshift(card);
          if (lastDrops.length > 6) lastDrops.pop();
          if (lastDropsList) {
            lastDropsList.innerHTML = '';
            lastDrops.forEach(c => {
              const li = document.createElement('li');
              li.className = 'd-flex align-items-center justify-content-between mb-1';
              li.innerHTML = `
            <div class="d-flex align-items-center gap-1 text-truncate me-2">
              <span>${raritySymbol(c.rarityInternal)}</span>
              <span class="text-truncate text-rarity-${c.rarityInternal}">${c.name}</span>
            </div>
            <span class="badge xsmall rarity-${c.rarityInternal}">${c.rarity.label}</span>
          `;
              lastDropsList.appendChild(li);
            });
          }

          const isNew = isNewToCollection(card.id);
          addCardToCollection(card);

          if (resultBox) {
            resultBox.innerHTML = `
          <div class="d-flex flex-column align-items-center">
            <span class="small mb-1">√öltima carta:</span>
            <span class="fw-semibold text-rarity-${card.rarityInternal}">${card.name}</span>
            <div class="d-flex gap-2 align-items-center mt-1">
               <span class="badge xsmall rarity-${card.rarityInternal}">${rd.label}</span>
               ${isNew ? '<span class="badge bg-danger xsmall">NEW</span>' : ''}
            </div>
          </div>
        `;
          }

          showToast(card);

          if (rewardModalEl && rewardModalInstance) {
            const rewardTitle = document.getElementById('rewardTitle');
            const rewardImg = document.getElementById('rewardImage');
            const rewardBadge = document.getElementById('rewardRarityBadge');
            const rewardSet = document.getElementById('rewardSetName');

            if (rewardTitle) {
              // const symbol = isNewToCollection(card.id) ? ' <span class="badge bg-danger">NEW</span>' : '';
              // rewardTitle.innerHTML = `¬°${rd.label}! ${card.name}${symbol}`;
              // User specified badge on the card image, keeping title clean or minimal
              rewardTitle.innerHTML = `¬°${rd.label}! ${card.name}`;
            }

            // Inject badge into image container
            const rewardCardInner = document.querySelector('.reward-card-inner');
            if (rewardCardInner) {
              // Remove old badge if any
              const oldBadge = rewardCardInner.querySelector('.badge-new-indicator');
              if (oldBadge) oldBadge.remove();

              // Badge l√≥gica movida arriba (isNew)
              if (isNew) {
                const badge = document.createElement('div');
                badge.className = 'badge-new-indicator';
                badge.textContent = 'NEW';
                // Remove animation for static display if preferred, or keep it
                rewardCardInner.appendChild(badge);
              }
            }
            if (rewardImg) rewardImg.src = card.image || 'img/avatars/pokeball.png';
            if (rewardBadge) {
              rewardBadge.textContent = rd.label;
              rewardBadge.className = 'badge rarity-' + card.rarityInternal;
            }
            if (rewardSet) rewardSet.textContent = card.setName || '';

            rewardModalInstance.show();
          }
        }

        // NO continuamos aqu√≠ los autogiros, solo marcamos que hay pendientes
        if (autoSpinsRemaining > 0) {
          autoSpinQueueActive = true;
        } else {
          autoSpinQueueActive = false;
          btnAuto.classList.remove('d-none');
          btnStopAuto.classList.add('d-none');
          btnSpin.disabled = balance < spinCost;
          btnAuto.disabled = balance < spinCost;
        }
      }

      function startSpin() {
        if (isSpinning) return;
        if (balance < spinCost) {
          showToast({
            name: 'No tienes monedas suficientes',
            rarity: { id: 1, label: 'Com√∫n', key: 'common' },
            rarityInternal: 'common'
          });
          autoSpinsRemaining = 0;
          autoSpinQueueActive = false;
          if (btnStopAuto) btnStopAuto.classList.add('d-none');
          if (btnAuto) btnAuto.classList.remove('d-none');
          return;
        }
        balance -= spinCost;
        syncCreditsUI();
        persistCredits();
        fillStrip();
        animateSpin();
      }

      if (btnSpin) {
        btnSpin.addEventListener('click', () => {
          autoSpinsRemaining = 0;
          autoSpinQueueActive = false;
          startSpin();
        });
      }

      if (btnAuto && btnStopAuto) {
        btnAuto.addEventListener('click', () => {
          if (isSpinning) return;
          const count = parseInt(autoCountSelect.value, 10) || 10;
          autoSpinsRemaining = count;
          autoSpinQueueActive = true;
          btnAuto.classList.add('d-none');
          btnStopAuto.classList.remove('d-none');
          startSpin();
        });

        btnStopAuto.addEventListener('click', () => {
          autoSpinsRemaining = 0;
          autoSpinQueueActive = false;
          if (autoSpinTimer) {
            clearTimeout(autoSpinTimer);
            autoSpinTimer = null;
          }
          btnAuto.classList.remove('d-none');
          btnStopAuto.classList.add('d-none');
          btnSpin.disabled = balance < spinCost;
          btnAuto.disabled = balance < spinCost;
        });
      }

      // Cuando cierras el modal de recompensa o pulsas "Seguir girando",
      // si quedan autogiros pendientes, lanza el siguiente.
      if (rewardContinueBtn && rewardModalEl && rewardModalInstance) {
        rewardContinueBtn.addEventListener('click', () => {
          rewardModalInstance.hide();
          if (autoSpinsRemaining > 0 && autoSpinQueueActive) {
            autoSpinsRemaining--;
            if (balance >= spinCost) {
              setTimeout(() => startSpin(), 250);
            } else {
              autoSpinsRemaining = 0;
              autoSpinQueueActive = false;
              btnAuto.classList.remove('d-none');
              btnStopAuto.classList.add('d-none');
            }
          } else {
            autoSpinQueueActive = false;
            btnAuto.classList.remove('d-none');
            btnStopAuto.classList.add('d-none');
            btnSpin.disabled = balance < spinCost;
            btnAuto.disabled = balance < spinCost;
          }
        });
      }

      if (wheelCards.length) {
        wheelCards.forEach(cardEl => {
          cardEl.addEventListener('click', () => {
            if (cardEl.classList.contains('active') || isSpinning) return;
            wheelCards.forEach(c => c.classList.remove('active'));
            cardEl.classList.add('active');

            currentWheelKey = cardEl.getAttribute('data-wheel') || 'common';
            updateSpinCostUI();
            updateBaseProbabilitiesUI();
            fillStrip();
          });
        });
      }

      if (btnGoCollection) {
        btnGoCollection.addEventListener('click', () => {
          window.location.href = 'Pages/Colecci√≥n.html';
        });
      }

      const storedCredits = localStorage.getItem('pm_credits');
      if (storedCredits) {
        const parsed = parseInt(storedCredits, 10);
        if (!isNaN(parsed)) {
          balance = parsed;
        }
      }

      function persistCredits() {
        localStorage.setItem('pm_credits', String(balance));
      }

      const creditButtons = document.querySelectorAll('.credit-buy-btn');
      creditButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const amount = parseInt(btn.getAttribute('data-amount'), 10) || 0;
          balance += amount;
          syncCreditsUI();
          persistCredits();
          btnSpin.disabled = balance < spinCost;
          btnAuto.disabled = balance < spinCost;
        });
      });

      function showPackInfo(packId) {
        const cfg = packRarityProbs[packId];
        if (!cfg || !packInfoModal) return;

        if (packInfoTitleEl) {
          packInfoTitleEl.textContent = `Probabilidades ‚Äì ${cfg.name}`;
        }
        if (packInfoListEl) {
          packInfoListEl.innerHTML = '';
          const entries = Object.entries(cfg.probs);
          entries.forEach(([key, p]) => {
            const rd = rarityDefs.find(r => r.key === key);
            const li = document.createElement('li');
            li.className = 'd-flex justify-content-between align-items-center mb-1';
            li.innerHTML = `
          <span>${rd ? rd.label : key}</span>
          <span class="fw-semibold">${(p * 100).toFixed(1)}%</span>
        `;
            packInfoListEl.appendChild(li);
          });
        }
        packInfoModal.show();
      }

      if (packsGrid) {
        const infoBtns = packsGrid.querySelectorAll('.pack-info-btn');
        infoBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const packId = btn.getAttribute('data-pack-id');
            showPackInfo(packId);
          });
        });
      }

      function showPackAnimation(cards, cfg) {
        if (!openPackModalEl || !packRevealStage || !packSummaryStage || !packRevealSlot) return;
        if (!openPackModal) openPackModal = new bootstrap.Modal(openPackModalEl);

        let index = 0;
        const total = cards.length;

        packSummaryStage.classList.add('d-none');
        packRevealStage.classList.remove('d-none');

        function renderCard(i) {
          const c = cards[i];
          const rd = c.rarity;
          packRevealSlot.innerHTML = `
        <div class="pack-reveal-card-inner rarity-${rd.key}">
          ${c.isNew ? '<div class="badge-new-indicator">NEW</div>' : ''}
          <img src="${c.image || 'img/avatars/pokeball.png'}"
               alt="${c.name}"
               style="width:100%;height:100%;object-fit:cover;">
        </div>
      `;
          if (packRevealCounter) {
            packRevealCounter.textContent = `Carta ${i + 1} de ${total}`;
          }
        }

        renderCard(index);

        if (btnNextReveal) {
          btnNextReveal.onclick = () => {
            index++;
            if (index >= total) {
              packRevealStage.classList.add('d-none');
              packSummaryStage.classList.remove('d-none');
              const grid = document.getElementById('packCardsGrid');
              if (grid) {
                grid.innerHTML = '';
                cards.forEach(c => {
                  const rd = c.rarity;
                  const col = document.createElement('div');
                  col.className = 'col-6 col-md-4 col-lg-3 mb-2';
                  col.innerHTML = `
                <article class="card card-carta h-100">
                  <div class="card-carta-frame">
                    ${c.isNew ? '<div class="badge-new-indicator">NEW</div>' : ''}
                    <div class="carta-img-placeholder d-flex align-items-center justify-content-center">
                      <img src="${c.image || 'img/avatars/pokeball.png'}"
                           class="carta-img-real"
                           alt="${c.name}">
                    </div>
                  </div>
                  <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                      <h5 class="small fw-semibold mb-0 text-truncate text-rarity-${rd.key}">${c.name}</h5>
                      <span class="badge xsmall rarity-${rd.key}">${rd.label}</span>
                    </div>
                    <p class="xsmall text-muted mb-0 text-truncate">${c.setName || ''}</p>
                  </div>
                </article>
              `;
                  grid.appendChild(col);
                });
              }
              return;
            }
            renderCard(index);
          };
        }

        const titleEl = openPackModalEl.querySelector('#openPackTitle');
        if (titleEl) titleEl.textContent = `${cfg.name} ‚Äì Apertura dopamina`;
        openPackModal.show();
      }

      function openPack(packId) {
        const cfg = packRarityProbs[packId];
        if (!cfg) return;

        if (balance < cfg.price) {
          showToast({
            name: `Necesitas ${cfg.price} monedas para este sobre`,
            rarity: rarityDefs[0],
            rarityInternal: 'common'
          });
          return;
        }

        const pool = (cardsByRarity['common'] || []);
        if (!pool.length) {
          showToast({
            name: 'Cargando cartas... Reintenta en unos segundos',
            rarity: rarityDefs[0],
            rarityInternal: 'common'
          });
          return;
        }

        balance -= cfg.price;
        syncCreditsUI();
        persistCredits();

        const cards = [];
        const numCards = cfg.cardCount || 3;

        for (let i = 0; i < numCards; i++) {
          const base = pool[Math.floor(Math.random() * pool.length)];
          const isNew = isNewToCollection(base.id);
          const cardWithSymbols = {
            ...base,
            isNew: isNew,
            rarityInternal: base.rarityInternal || 'common',
            rarity: rarityDefs.find(r => r.key === (base.rarityInternal || 'common')) || rarityDefs[0]
          };
          cards.push(cardWithSymbols);
          addCardToCollection(cardWithSymbols);
        }

        showPackAnimation(cards, cfg);
      }

      if (packsGrid) {
        const openButtons = packsGrid.querySelectorAll('.pack-open-btn');
        openButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const packId = btn.getAttribute('data-pack-id');
            openPack(packId);
          });
        });
      }

      function generateDailyCards(forceRandom = false) {
        if (!dailyCardsGrid || !dailyCardTemplate) return;

        dailyCardsGrid.innerHTML = '';
        const seedBase = getDailySeed();

        const pool = Object.values(cardsByRarity).flat();
        console.log('Daily shop pool size:', pool.length);

        if (!pool.length) {
          if (dailyEmptyText) {
            dailyEmptyText.textContent = 'Mercado sincronizando... (Vuelve a entrar o pulsa Recargar)';
            dailyCardsGrid.appendChild(dailyEmptyText);
          }
          return;
        }

        const numDaily = 3;
        const usedIndexes = new Set();

        for (let i = 0; i < numDaily; i++) {
          let idx;
          if (forceRandom) {
            let tries = 0;
            do {
              idx = Math.floor(Math.random() * pool.length);
              tries++;
            } while (usedIndexes.has(idx) && tries < 20);
          } else {
            const seed = `${seedBase}-${i}`;
            idx = seededRandom(seed, pool.length);
          }

          usedIndexes.add(idx);
          const card = pool[idx];

          const clone = dailyCardTemplate.cloneNode(true);
          clone.id = '';
          clone.classList.remove('d-none');

          const nameEl = clone.querySelector('.daily-name');
          const rarityEl = clone.querySelector('.daily-rarity');
          const setEl = clone.querySelector('.daily-set');
          const priceEl = clone.querySelector('.daily-price');
          const stockEl = clone.querySelector('.daily-stock');
          const buyBtn = clone.querySelector('.daily-buy-btn');
          const imgWrap = clone.querySelector('.carta-img-placeholder');

          if (nameEl) nameEl.textContent = card.name || 'Carta sin nombre';
          if (setEl) setEl.textContent = card.setName || 'Set desconocido';

          // Usar la rareza interna precalculada o recalcular
          const internal = card.rarityInternal || 'rare';
          const rd = rarityDefs.find(r => r.key === internal) || rarityDefs[2];

          const basePrice = rarityPriceMap[internal] || 50;
          if (priceEl) priceEl.textContent = basePrice.toString();

          if (rarityEl) {
            rarityEl.textContent = rd.label;
            rarityEl.className = 'badge xsmall rarity-' + rd.key;
          }

          if (nameEl) {
            nameEl.classList.add(`text-rarity-${internal}`);
          }

          // Check if sold
          const soldKey = `daily_sold_${seedBase}_${i}`;
          const isSold = localStorage.getItem(soldKey) === 'true';

          if (stockEl) stockEl.textContent = 'Stock: ' + (isSold ? '0' : '1');

          const soldOverlap = clone.querySelector('.daily-sold-overlap');
          if (isSold) {
            clone.querySelector('.tienda-card-dia').classList.add('sold');
            if (soldOverlap) soldOverlap.classList.remove('d-none');
            if (buyBtn) {
              buyBtn.disabled = true;
              buyBtn.textContent = 'Agotado';
            }
          }

          if (imgWrap) {
            const cardImgUrl = card.image || 'img/avatars/pokeball.png';
            const isNew = isNewToCollection(card.id);
            imgWrap.innerHTML = `
              ${(isNew && !isSold) ? '<div class="badge-new-indicator">NEW</div>' : ''}
              <img src="${cardImgUrl}" class="daily-img carta-img-real" alt="${card.name}">
            `;
          }

          if (buyBtn && !isSold) {
            buyBtn.addEventListener('click', () => {
              const price = parseInt(priceEl.textContent, 10) || 0;
              if (balance < price) {
                showToast({
                  name: 'No tienes monedas suficientes',
                  rarity: { id: 1, label: 'Com√∫n', key: 'common' },
                  rarityInternal: 'common'
                });
                return;
              }
              balance -= price;
              syncCreditsUI();
              persistCredits();

              // Mark as sold
              localStorage.setItem(soldKey, 'true');

              // UI update
              const cardArticle = clone.querySelector('.tienda-card-dia');
              cardArticle.classList.add('sold');
              if (soldOverlap) soldOverlap.classList.remove('d-none');
              buyBtn.disabled = true;
              buyBtn.textContent = 'Agotado';
              if (stockEl) stockEl.textContent = 'Stock: 0';

              addCardToCollection({
                id: card.id,
                setId: card.setId,
                localId: card.localId,
                name: card.name,
                rarityInternal: internal,
                rarity: rd,
                image: card.image,
                apiRarity: card.apiRarity,
                setName: card.setName,
                types: card.types || [],
                holographic: card.holographic || false,
                priceEur: card.priceEur ?? null,
                priceUsd: card.priceUsd ?? null
              });
              showToast({
                name: `Comprada: ${card.name}`,
                rarity: rd,
                rarityInternal: internal
              });

              // Quitar el circulito de NEW ya que ha sido comprada
              const badge = clone.querySelector('.badge-new-indicator');
              if (badge) badge.remove();
            });
          }

          dailyCardsGrid.appendChild(clone);
        }

        if (dailyEmptyText) {
          dailyEmptyText.textContent = '';
        }
      }

      if (btnRefreshDaily) {
        btnRefreshDaily.addEventListener('click', () => {
          if (balance < refreshDailyCost) {
            showToast({
              name: 'No tienes monedas para recargar la tienda',
              rarity: { id: 1, label: 'Com√∫n', key: 'common' },
              rarityInternal: 'common'
            });
            return;
          }
          balance -= refreshDailyCost;
          syncCreditsUI();
          persistCredits();

          // Clear sold status for the current day's slots before regenerating
          const todaySeed = getDailySeed();
          // We know numDaily is 3 constant now, but let's be safe
          for (let i = 0; i < 8; i++) {
            localStorage.removeItem(`daily_sold_${todaySeed}_${i}`);
          }

          refreshDailyCost += 50;
          updateRefreshCostUI();
          generateDailyCards(true);
        });
      }

      // Carga inicial optimizada
      loadAllCardsFromApi().then(() => {
        fillStrip();
        generateDailyCards();
      });

      updateSpinCostUI();
      updateBaseProbabilitiesUI();
      updateCurrentProbabilities();
      updateRefreshCostUI();
      syncCreditsUI();

      // L√≥gica Tienda de Monedas (Nueva + Admin)
      const coinCards = document.querySelectorAll('.coin-pack-card');
      const adminInput = document.getElementById('adminCodeInput');
      const btnRedeem = document.getElementById('btnRedeemCode');

      coinCards.forEach(card => {
        card.addEventListener('click', () => {
          if (card.classList.contains('processing')) return; // Prevent double click

          const amount = parseInt(card.getAttribute('data-amount')) || 0;
          const cost = card.getAttribute('data-cost');

          // Simulation visual feedback (2 seconds)
          const originalText = card.querySelector('.coin-pack-price').textContent;
          const priceEl = card.querySelector('.coin-pack-price');

          card.classList.add('processing');
          priceEl.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';

          setTimeout(() => {
            card.classList.remove('processing');
            priceEl.textContent = originalText;

            balance += amount;
            syncCreditsUI();

            // Safe persist
            if (typeof persistCredits === 'function') persistCredits();
            localStorage.setItem('pm_credits', balance);

            // Close modal by ID
            const modalEl = document.getElementById('creditShopModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();

            showToast({
              name: `¬°Pago completado! Has recibido ${amount.toLocaleString()} monedas.`,
              rarity: { id: 7, label: 'Pago Exitoso', key: 'mythic' },
              rarityInternal: 'mythic'
            });
          }, 2000); // 2.0s delay simulation
        });
      });

      if (btnRedeem) {
        btnRedeem.addEventListener('click', () => {
          const code = adminInput.value.trim();
          if (code === '1234') {
            const bonus = 100000;
            balance += bonus;
            syncCreditsUI();
            if (typeof persistCredits === 'function') persistCredits();
            localStorage.setItem('pm_credits', balance);

            showToast({
              name: `C√≥digo ADMIN canjeado: +${bonus.toLocaleString()}`,
              rarity: { id: 8, label: 'ADMIN', key: 'legendary' },
              rarityInternal: 'legendary'
            });
            adminInput.value = '';
          } else {
            showToast({
              name: 'C√≥digo inv√°lido (Prueba 1234)',
              rarity: { id: 1, label: 'Error', key: 'common' },
              rarityInternal: 'common'
            });
          }
        });
      }

      window.addEventListener('beforeunload', () => {
        persistCredits();
      });
    });
  </script>

  <!-- Modal PEGI 18 / Juego Responsable -->
  <div class="modal fade shadow-lg" id="pegiModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
        <div class="modal-header bg-danger text-white border-0 py-3">
          <h5 class="modal-title d-flex align-items-center gap-2 fw-bold">
            <i class="bi bi-exclamation-triangle-fill"></i>
            ¬°ADVERTENCIA DE SEGURIDAD!
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body p-4 text-center bg-white">
          <img src="img/pegi18.svg" alt="PEGI 18" style="width: 100px;" class="mb-4">
          <h4 class="fw-bold mb-3 text-black">Clasificaci√≥n PEGI 18</h4>

          <div class="alert alert-warning border-0 px-3 py-3 text-start mb-4 shadow-sm"
            style="background-color: #fff3cd; color: #856404; font-size: 0.95rem;">
            <p class="mb-2"><strong><i class="bi bi-info-circle-fill me-1"></i> Contenido:</strong> Gasto de moneda
              virtual para obtenci√≥n de recompensas aleatorias (Simulaci√≥n de apuestas).</p>
            <p class="mb-0"><strong><i class="bi bi-person-fill-lock me-1"></i> Restricci√≥n:</strong> Funciones
              restringidas estrictamente a personas <strong>mayores de 18 a√±os</strong>.</p>
          </div>

          <div class="text-start mb-4">
            <h6 class="fw-bold text-uppercase small text-muted mb-3 border-bottom pb-2">Sobre el Juego Responsable:</h6>
            <p class="text-black mb-3" style="font-size: 1rem; line-height: 1.5;">La mec√°nica de ruletas y sobres puede
              generar comportamientos adictivos. La <strong>ludopat√≠a</strong> es un problema de salud serio que afecta
              a la vida personal y financiera.</p>
            <ul class="ps-3 mb-4 text-black" style="font-size: 0.95rem; line-height: 1.6;">
              <li class="mb-2">No utilices esta aplicaci√≥n para evadir problemas o estados de √°nimo negativos.</li>
              <li class="mb-2">Establece l√≠mites de tiempo y gasto, y nunca intentes "recuperar" lo perdido.</li>
              <li>Los objetos obtenidos son virtuales y <strong>no tienen valor monetario real</strong>.</li>
            </ul>

            <div class="p-3 rounded-3 border border-danger-subtle bg-light text-center">
              <p class="mb-2 text-dark font-monospace small">¬øNECESITAS AYUDA PROFESIONAL?</p>
              <div class="d-flex flex-column gap-2">
                <a href="https://www.jugarbien.es" target="_blank" class="btn btn-sm btn-danger fw-bold shadow-sm">
                  <i class="bi bi-box-arrow-up-right me-1"></i> VISITAR JUGARBIEN.ES
                </a>
                <a href="https://fejar.org" target="_blank" class="btn btn-sm btn-outline-danger shadow-sm">
                  <i class="bi bi-telephone-fill me-1"></i> CONTACTAR CON FEJAR
                </a>
              </div>
            </div>
          </div>

          <button type="button" class="btn btn-dark w-100 rounded-pill py-3 fw-bold shadow mt-2" data-bs-dismiss="modal"
            style="font-size: 1.1rem; letter-spacing: 0.5px;">
            HE LE√çDO Y ENTIENDO LOS RIESGOS
          </button>
        </div>
      </div>
    </div>
  </div>

</body>

</html>